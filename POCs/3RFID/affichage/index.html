<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Tableau RFID en temps réel</title>
  <style>
    body { font-family: sans-serif; margin:20px; }
    h1 { margin-top:1em; }
    .category { float:left; width:30%; margin-right:3%; }
    .category:last-child { margin-right:0; }
    .category h2 { text-transform:capitalize; text-align:center; }
    .words { list-style:none; padding:0; }
    .words li { padding:4px; }
    .current { background: #ffff99; }
    .selected { font-weight:bold; }
    #footer { clear:both; margin-top:1em; font-style:italic; }
  </style>
</head>
<body>
  <h1>Tableau actuel</h1>
  <!-- Affiche le numéro du set courant -->
  <h2 id="currentSet"></h2>
  <div id="tableau"></div>
  <div id="footer"></div>

  <h1>Mots posés</h1>
  <div id="placed"></div>

  <script>
    const moduleId = 3;
    const serverUrl = `127.0.0.1:8000`;
    let assignments, wanted;
    let ws;

    // 1. Récupère assignments depuis la config
    async function fetchConfig() {
      const res  = await fetch(`http://${serverUrl}/config?module=${moduleId}`);
      const json = await res.json();
      assignments = json.config.assignments;
      // construit wanted : liste des mots par catégorie
      wanted = {};
      for (const cat of ['lieux','couleurs','emotions']) {
        wanted[cat] = Object.keys(assignments[cat] || {});
      }
      renderTableau();
      setupWebSocket();
      requestBuffer();          
      setInterval(requestBuffer, 1000);
    }

    // 2. Affiche la grille sans id dynamiques, mais avec data-attributes
    function renderTableau() {
      const container = document.getElementById('tableau');
      container.innerHTML = '';
      for (const cat of ['lieux','couleurs','emotions']) {
        const div = document.createElement('div');
        div.className = 'category';
        div.innerHTML = `<h2>${cat}</h2>`;
        const ul = document.createElement('ul');
        ul.className = 'words';
        for (const word of wanted[cat]) {
          const li = document.createElement('li');
          li.textContent = word;
          li.setAttribute('data-cat',  cat);
          li.setAttribute('data-word', word);
          ul.appendChild(li);
        }
        div.appendChild(ul);
        container.appendChild(div);
      }
      document.getElementById('footer').innerHTML = '';
    }

    // 3. WS pour récupérer le buffer
    function setupWebSocket() {
      ws = new WebSocket(`ws://${serverUrl}/ws`);
      ws.onopen    = () => console.log('WS ouverte');
      ws.onmessage = e => {
        let msg;
        try { msg = JSON.parse(e.data); }
        catch(_) { return; }
        if (msg.action === 'get_buffer') {
          updatePlaced(msg.buffer);
        }
      };
      ws.onclose = () => setTimeout(setupWebSocket, 5000);
    }
    function requestBuffer() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ module: moduleId, action: 'get' }));
      }
    }

    // 4. Mise à jour en temps réel
    function updatePlaced(buffer) {
      // a) affiche current_set
      const setEl = document.getElementById('currentSet');
      setEl.textContent = buffer.current_set
        ? `Feuille n° ${buffer.current_set}`
        : '';

      // b) affiche les mots posés + surligne dans la grille
      const placedDiv = document.getElementById('placed');
      placedDiv.innerHTML = '';
      ['lieux','couleurs','emotions'].forEach((cat,i) => {
        const uid = buffer[['uid1','uid2','uid3'][i]];
        let word = '';
        if (uid) {
          for (const w of wanted[cat]) {
            if (assignments[cat][w] === uid) { word = w; break; }
          }
        }
        console.log(`Catégorie ${cat} : uid=${uid}, mot=${word}`);
        // paragraphe "Catégorie : mot"
        const p = document.createElement('p');
        p.innerHTML = `<strong>${cat}:</strong> ${word||'<em>(aucun)</em>'}`;
        placedDiv.appendChild(p);

        // supprime d'abord les classes sur toute la catégorie
        document
          .querySelectorAll(`li[data-cat="${cat}"]`)
          .forEach(el => el.classList.remove('current','selected'));

        // puis ajoute si on a un mot
        if (word) {
          const sel = document.querySelector(`li[data-cat="${cat}"][data-word="${CSS.escape(word)}"]`);
          sel?.classList.add('current','selected');
        }
      });
    }

    window.addEventListener('load', fetchConfig);
  </script>
</body>
</html>
